# 微信公众号

## 1. 微信公众号简介

### 1.1. 微信公众号是什么

​	微信公众平台, 是个人, 企业和阻止提供业务服务于用户管理能力的全新服务平台.

​	简单来说, 一个提供服务的平台.

### 1.2. 微信公众号的分类

#### 1.2.1. 订阅号

- 简介
  - 为媒体和个人提供一种新的信息传播方式, 主要功能是在微信侧给用户传达资讯; (功能类似报纸杂志, 提供新闻信息或娱乐趣事)
- 适用主要人群
  - 个人, 媒体
- 群发次数
  - 订阅号(认证用户, 非认证用户): 1 天内可群发 1 条消息

#### 1.2.2. 服务号

- 简介
  - 为企业和组织提供更强大的业务服务于用户管理能力, 主要偏向服务类交互; (功能类似银行, 12315, 114等)
- 适用主要人群
  - 企业, 政府或其他组织
- 群发次数
  - 服务号: 1 个月(按自然月)内可发送 4 条群发消息

#### 1.2.3. 小程序

- 简介
  - 小程序是一种新的开放能力, 开发者可以快速的开发一个小程序. 小程序可以在微信内被便捷的获取和传播, 同时具有出色的使用体验

#### 1.2.4. 企业微信(原企业号)

- 简介
  - 企业微信继承企业号所有能力, 同时为企业提供专业的通讯工具, 丰富的办公应用与API, 助力企业高效沟通与办公

### 1.3. 订阅号和服务号的主要区别

|          | 订阅号                | 服务号                     |
| -------- | :-------------------- | :------------------------- |
| 推送频率 | 1 天内可群发 1 条消息 | 1个月内可发送 4 条群发消息 |
| 提供功能 | 包含大部分功能        | 认证的服务号包含全部功能   |
| 适用人群 | 个人, 媒体            | 企业, 政府或其他组织       |

### 1.4. 注册微信公众号

- 注册网址: [https://mp.weixin.qq.com](https://mp.weixin.qq.com/)

- 注册流程

  ```ini
  1. 打开官网, 点击右上角的立即注册
  2. 选择订阅号注册
  3. 依次输入要求的信息, 勾上我同意, 点击注册
  4. 选择中国内地, 点击确定
  5. 选择订阅号, 确定
  6. 主体类型选择个人, 填好信息后点击继续, 点击完成
  ```

### 1.5. 使用微信号

​	登录后, 页面左边将会有一排功能选项, 订阅号中有一些功能可以直接设置使用

## 2. 微信公众号的开发

### 2.1. 验证消息的合法性

#### 2.1.1. 填写服务器配置

```ini
开发/开发者工具 -> 公众平台测试帐号 -> 填写URL, Token -> 提交

URL: ngrok内网穿透后的地址
Token: 随意填写

# ngrok 内网穿透
1. 下载 ngork 客户端: https://ngrok.com/download
2. 启动本地服务器, 如: http://localhsot:9000
3. 打开 ngrok 客户端, 输入: ngrok http 9000, 启动内网穿透
4. 复制生成后的网址:   Forwarding  http://feea631e.ngrok.io -> http://localhost:9000
```



#### 2.1.2. 验证服务器地址的有效性

```js
/**
 * 验证服务器的有效性
 *
 *  1. 微信服务器验证开发者服务器
 *    - 测试号管理 -> 接口配置信息
 *    - 填写URL
 *      - 使用 ngrok 内网穿透, 将本地端口号开启的服务映射成外网访问的网址
 *      - ngrok http 9000
 *    - 填写TOKEN
 *      - 参与微信签名加密的一个参数
 *  2. 开发者服务器 -> 验证消息是否来自于微信服务器
 *    - 目的: 计算出signature微信加密签名, 和微信传递过来的signature进行对比, 如果一样, 说明消息来自于微信服务器, 如果不一样, 说明不是微信服务器发送的消息
 *    1. 将参与微信加密签名的三个参数(timestamp, nonce, token)按照字段顺序排序并组合在一起形成一个数组
 *    2. 将数组里所有参数拼接成一个字符串, 进行sha1加密
 *    3. 加密完成就生成了一个signature, 和微信发送过来的进行对比,
 *      如果一样, 说明消息来自于微信服务器, 返回echostr给微信服务器
 *      如果不一样, 说明不是微信服务器发送的消息, 返回error
 */
```



```js
// 引入express模块
const express = require('express')
// 引入sha1模块
const sha1 = require('sha1')

// 创建app应用对象
const app = express()

// 定义配置对象
const config = {
  token: 'colg',
  appID: 'wxab24c63af48de474',
  appsecret: 'c9508bc4dea8ef7b65995cd94ba7323d'
}

// 接收处理所有消息
app.use((req, res, next) => {
  const {signature, echostr, timestamp, nonce} = req.query
  const {token} = config

  console.log(`接收到来自微信服务器的认证消息: [${signature}, ${timestamp}, ${nonce}, ${echostr}]`)
 

  // 1. 将参与微信加密签名的三个参数(timestamp, nonce, token)按照字段顺序排序并组合在一起形成一个数组
  const arrSort = [timestamp, nonce, token].sort()

  // 2. 将数组里所有参数拼接成一个字符串, 进行sha1加密
  const str = arrSort.join('')
  const sha1Str = sha1(str)

  // 3. 加密完成就生成了一个signature, 和微信发送过来的进行对比
  if (sha1Str === signature) {
    // 如果一样, 说明消息来自于微信服务器, 返回echostr给微信服务器
    res.send(echostr)
  } else {
    // 如果不一样, 说明不是微信服务器发送的消息, 返回error
    res.send('error')
  }

})

// 监听端口号
app.listen(9000, () => console.log(`服务器启动成功了: ${new Date().toLocaleString()}`))
```



#### 2.1.3. 依据接口文档实现业务逻辑

​	验证URL有效性成功后即接入生效, 成为开发者. 可以在公众平台申请微信认证, 认证成功后, 将获得更多接口权限, 满足更多业务需求.

### 2.2. 获取`access_token`

​	`access_token`是公众号的全局唯一接口调用凭据, 公众号调用各接口时都需要使用access_token. 开发者需要进行妥善保存.

#### 2.2.1. 目录结构

#### 2.2.2. 代码

### 2.3. 自动回复消息

### 2.4. 上传素材

### 2.5. 菜单

### 2.6. 用户管理

### 2.7. 群发消息

## 3. 微信公众号交互流程

## 4. 微信公众号 JS-SDK